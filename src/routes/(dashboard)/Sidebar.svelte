<script lang="ts">
  import { afterNavigate } from "$app/navigation";
  import { page } from "$app/state";
  import {
    Sidebar,
    SidebarDropdownWrapper,
    SidebarGroup,
    SidebarItem,
    SidebarWrapper,
    SidebarButton,
    uiHelpers,
  } from "flowbite-svelte";
  import {
    AngleDownOutline,
    AngleUpOutline,
    ClipboardListSolid,
    CogOutline,
    FileChartBarSolid,
    GithubSolid,
    LayersSolid,
    LifeSaverSolid,
    LockSolid,
    WandMagicSparklesOutline,
    ChartPieOutline,
    RectangleListSolid,
    TableColumnSolid,
    GridSolid,
    FireOutline,
    BookOpenOutline,
    UserSolid,
  } from "flowbite-svelte-icons";

  interface Props {
    drawerHidden: boolean;
    docsRoute: string[];
  }
  let { drawerHidden = $bindable(false), docsRoute }: Props = $props();
  // console.log('data in Sidebar docsRoute:', docsRoute)
  const closeDrawer = () => {
    drawerHidden = true;
  };

  let iconClass =
    "flex-shrink-0 w-6 h-6 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-300 dark:group-hover:text-white";
  let itemClass =
    "flex items-center p-2 text-base text-gray-900 transition duration-75 rounded-lg hover:bg-gray-100 group dark:text-gray-200 dark:hover:bg-gray-700 w-full";
  let groupClass = "pt-2 space-y-2 mb-3";

  let activeUrl = $derived(page.url.pathname);
  let activeMainSidebar: string;

  const sidebarUi = uiHelpers();
  let isOpen = $state(false);
  const closeSidebar = sidebarUi.close;
  $effect(() => {
    isOpen = sidebarUi.isOpen;
    activeUrl = page.url.pathname;
  });

  afterNavigate((navigation) => {
    // this fixes https://github.com/themesberg/flowbite-svelte/issues/364
    document.getElementById("svelte")?.scrollTo({ top: 0 });
    closeDrawer();

    activeMainSidebar = navigation.to?.url.pathname ?? "";
  });

  let posts: Array<{
    name: string;
    Icon: any;
    href?: string;
    children?: Record<string, string>;
  }> = [
    { name: "Dashboard", Icon: ChartPieOutline, href: "/dashboard" },
    { name: "Users", Icon: UserSolid, href: "/users" },
    // {
    //   name: "CRUD",
    //   Icon: RectangleListSolid,
    //   children: {
    //     Products: "/crud/products",
    //     Users: "/crud/users",
    //   },
    // },
    // {
    //   name: "Authentication",
    //   Icon: LockSolid,
    //   children: {
    //     "Sign in": "/authentication/sign-in",
    //     "Sign up": "/authentication/sign-up",
    //     "Forgot password": "/authentication/forgot-password",
    //     "Reset password": "/authentication/reset-password",
    //     "Profile lock": "/authentication/profile-lock",
    //   },
    // },
    // {
    //   name: "Playground",
    //   Icon: WandMagicSparklesOutline,
    //   children: {
    //     Stacked: "/playground/stacked",
    //     Sidebar: "/playground/sidebar",
    //   },
    // },
  ];

  let links: Array<{
    label: string;
    href: string;
    Icon: any;
  }> = [
    // {
    //   label: "GitHub Repository",
    //   href: "https://github.com/themesberg/flowbite-svelte-admin-dashboard",
    //   Icon: GithubSolid,
    // },
    // {
    //   label: "Flowbite Svelte",
    //   href: "https://flowbite-svelte.com/docs/pages/quickstart",
    //   Icon: ClipboardListSolid,
    // },
    // {
    //   label: "Components",
    //   href: "https://flowbite-svelte.com/docs/components/accordion",
    //   Icon: LayersSolid,
    // },
    // {
    //   label: "Support",
    //   href: "https://github.com/themesberg/flowbite-svelte-admin-dashboard/issues",
    //   Icon: LifeSaverSolid,
    // },
  ];
  let dropdowns = Object.fromEntries(Object.keys(posts).map((x) => [x, false]));
</script>

<SidebarButton
  breakpoint="lg"
  onclick={sidebarUi.toggle}
  class="fixed top-[22px] z-40 mb-2"
/>
<Sidebar
  breakpoint="lg"
  backdrop={false}
  {isOpen}
  {closeSidebar}
  params={{ x: -50, duration: 50 }}
  class="top-0 left-0 mt-[69px] h-screen w-64 bg-gray-50 transition-transform lg:block dark:bg-gray-800 border-r rounded-lg border-gray-200 shadow-md dark:border-gray-700 "
  classes={{
    div: "h-full px-3 py-4 overflow-y-auto bg-gray-50 dark:bg-gray-800",
    nonactive: "p-2",
    active: "p-2",
  }}
>
  <h4 class="sr-only">Main menu</h4>
  <SidebarWrapper
    class="scrolling-touch top-2 h-full max-w-2xs overflow-y-auto bg-white px-3 pt-6 lg:sticky lg:me-0 lg:block lg:h-[calc(100vh-4rem)] lg:pt-5 dark:bg-gray-800"
  >
    <SidebarGroup class={groupClass}>
      {#each posts as { name, Icon, children, href } (name)}
        {#if children}
          <SidebarDropdownWrapper label={name} class="pr-3">
            {#snippet arrowdown()}
              <AngleDownOutline strokeWidth="3.3" size="sm" />
            {/snippet}
            {#snippet arrowup()}
              <AngleUpOutline strokeWidth="3.3" size="sm" />
            {/snippet}
            {#snippet icon()}
              {#if Icon}<Icon class={iconClass} />{/if}
            {/snippet}
            {#each Object.entries(children) as [title, href]}
              <SidebarItem
                label={title}
                {href}
                spanClass="ml-9"
                class={itemClass}
                aClass="w-full"
              />
            {/each}
          </SidebarDropdownWrapper>
        {:else}
          <SidebarItem
            label={name}
            {href}
            spanClass="ml-3"
            class={itemClass}
            aClass="w-full p-0 py-2"
          >
            {#snippet icon()}
              <Icon class={iconClass} />
            {/snippet}
          </SidebarItem>
        {/if}
      {/each}
    </SidebarGroup>

    <SidebarGroup class={groupClass}>
      {#each links as { label, href, Icon } (label)}
        <SidebarItem
          {label}
          {href}
          spanClass="ml-3"
          class={itemClass}
          target="_blank"
        >
          {#snippet icon()}
            <svelte:component this={Icon} class={iconClass} />
          {/snippet}
        </SidebarItem>
      {/each}
    </SidebarGroup>
  </SidebarWrapper>
</Sidebar>
